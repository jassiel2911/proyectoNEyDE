{% extends 'base.html' %}

{% block content %}
<div id="app">
    <div class="container mt-4">
        <h1>Panel de Negocios</h1>

        <div v-if="negocios.length === 0 || mostrarFormularioNegocio">
            <h2>Crear Nuevo Negocio</h2>
            <form @submit.prevent="crearNegocio">
                {% csrf_token %}
                <div class="form-group">
                    <label for="nombre">Nombre del Negocio</label>
                    <input type="text" class="form-control" id="nombre" v-model="nuevoNegocio.nombre" required>
                </div>
                <div class="form-group">
                    <label for="descripcion">Descripción</label>
                    <textarea class="form-control" id="descripcion" v-model="nuevoNegocio.descripcion"></textarea>
                </div>
                <div class="form-group">
                    <label for="direccion">Dirección</label>
                    <input type="text" class="form-control" id="direccion" v-model="nuevoNegocio.direccion" required>
                </div>
                <button type="submit" class="btn btn-primary">Crear Negocio</button>
            </form>
        </div>

        <div v-else>
            <button @click="activarFormularioNegocio" class="btn btn-success mb-3">Agregar Nuevo Negocio</button>

        </div>

        <div v-if="negocios.length > 0">
            <h2>Mis Negocios</h2>
            <div class="form-group">
                <label for="negocio-seleccionado">Seleccionar Negocio:</label>
                <select class="form-control" id="negocio-seleccionado" v-model="negocioSeleccionadoId" @change="cargarProductosYPedidos">
                    <option value="">Seleccione un negocio</option>
                    <option v-for="negocio in negocios" :key="negocio.id" :value="negocio.id">
                        [[ negocio.nombre ]]
                    </option>

                </select>
            </div>

            <div v-if="negocioSeleccionadoId">
                <h3 v-html="'Gestionar Productos de ' + (negocioSeleccionado?.nombre || 'Negocio no seleccionado')"></h3>
                <button @click="mostrarFormularioProducto" class="btn btn-success mb-3">Agregar Producto</button>

                <div v-if="mostrarFormulario">
                    <form @submit.prevent="guardarProducto">
                        <div class="form-group">
                            <label for="nombre">Nombre</label>
                            <input type="text" class="form-control" id="nombre" v-model="producto.nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="descripcion">Descripción</label>
                            <textarea class="form-control" id="descripcion" v-model="producto.descripcion"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="precio">Precio</label>
                            <input type="number" step="0.01" class="form-control" id="precio" v-model="producto.precio" required>
                        </div>
                        <div class="form-group">
                            <label for="stock">Stock</label>
                            <input type="number" class="form-control" id="stock" v-model="producto.stock" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                        <button type="button" class="btn btn-secondary" @click="cancelarFormulario">Cancelar</button>
                    </form>
                </div>

                <table class="table" v-if="productos.length > 0">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="producto in productos">
                            <td>[[ producto.nombre ]]</td>
                            <td>[[ producto.precio ]]</td>
                            <td>[[ producto.stock ]]</td>
                            <td>
                                <button @click="editarProducto(producto)" class="btn btn-sm btn-warning">Editar</button>
                                <button @click="eliminarProducto(producto.id)" class="btn btn-sm btn-danger">Eliminar</button>
                            </td>
                        </tr>

                    </tbody>
                </table>
                <p v-else>No hay productos registrados.</p>

                <h3 v-html="'Pedidos Recibidos de ' + (negocioSeleccionado?.nombre || 'Negocio no seleccionado')"></h3>

                <p>Esta sección se implementará más adelante.</p>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const app = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            negocios: [],
            negocioSeleccionadoId: "",
            productoEditandoId: null,
            productos: [],
            mostrarFormulario: false,
            mostrarFormularioNegocio: false,
            producto: {
                nombre: '',
                descripcion: '',
                precio: 0,
                stock: 0
            },
            nuevoNegocio: {
                nombre: '',
                descripcion: '',
                direccion: ''
            }
        },
        mounted() {
            this.fetchNegocios(); // Llamada inicial para obtener los negocios
        },
        methods: {
            getAuthHeaders() {
                const token = localStorage.getItem('token');
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${token}`
                };
            },
            fetchNegocios() {
                fetch('/api/negocios/', {
                    headers: this.getAuthHeaders()
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Datos crudos de negocios:', data);

                        // Aplanar objetos para quitar el reactivity wrapper de Vue
                        this.negocios = data.map(n => ({
                            id: n.id,
                            nombre: n.nombre,
                            descripcion: n.descripcion,
                            direccion: n.direccion,
                            usuario: n.usuario
                        }));

                        if (this.negocios.length > 0) {
                            // no seleccionar negocio automáticamente
                        }

                    })
                    .catch(error => {
                        console.error('Error al obtener negocios:', error);
                    });
            },
            crearNegocio() {
                console.log('Enviando negocio:', this.nuevoNegocio);
                fetch('/api/negocios/', {
                    method: 'POST',
                    headers: {
                        ...this.getAuthHeaders(),
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(this.nuevoNegocio)
                })
                    .then(async response => {
                        const data = await response.json();
                        console.log('Respuesta del backend:', data);
                        if (response.ok) {
                            this.fetchNegocios(); // Recargar la lista de negocios
                            this.nuevoNegocio = { nombre: '', descripcion: '', direccion: '' }; // Limpiar el formulario
                        } else {
                            alert('Error al crear el negocio: ' + (data?.usuario?.[0] || 'Por favor, inténtelo de nuevo.'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al crear el negocio. Por favor, inténtelo de nuevo.');
                    });
            },
            cargarProductosYPedidos() {
                this.fetchProductos();
            },
            fetchProductos() {
                fetch(`/api/productos/?negocio=${this.negocioSeleccionadoId}`, {
                    headers: this.getAuthHeaders()
                })
                    .then(response => response.json())
                    .then(data => {
                        this.productos = data;
                    })
                    .catch(error => console.error('Error al obtener productos:', error));
            },
            mostrarFormularioProducto() {
                this.mostrarFormulario = true;
                this.producto = { nombre: '', descripcion: '', precio: 0, stock: 0 };
            },
            cancelarFormulario() {
                this.mostrarFormulario = false;
                this.producto = { nombre: '', descripcion: '', precio: 0, stock: 0 };
                this.productoEditandoId = null;
            },

            guardarProducto() {
                const productoPayload = { ...this.producto };
                productoPayload.negocio = this.negocioSeleccionadoId;  // Asegúrate de asociarlo al negocio correcto

                // Si estamos editando un producto
                if (this.productoEditandoId) {
                    // PUT: Editar producto existente
                    fetch(`/api/productos/${this.productoEditandoId}/`, {
                        method: 'PUT',
                        headers: this.getAuthHeaders(),
                        body: JSON.stringify(productoPayload)
                    })
                        .then(async res => {
                            if (!res.ok) {
                                const error = await res.json();
                                console.error('Error al actualizar el producto:', error);
                                alert('No se pudo actualizar el producto.');
                                return;
                            }
                            this.fetchProductos();  // Recargar productos
                            this.cancelarFormulario();  // Limpiar formulario
                        })
                        .catch(error => {
                            console.error('Error al actualizar producto:', error);
                            alert('No se pudo actualizar el producto.');
                        });
                } else {
                    // POST: Crear un nuevo producto
                    fetch('/api/productos/', {
                        method: 'POST',
                        headers: this.getAuthHeaders(),
                        body: JSON.stringify(productoPayload)
                    })
                        .then(async res => {
                            if (!res.ok) {
                                const error = await res.json();
                                console.error('Error al crear producto:', error);
                                alert('No se pudo crear el producto.');
                                return;
                            }
                            this.fetchProductos();  // Recargar productos
                            this.cancelarFormulario();  // Limpiar formulario
                        })
                        .catch(error => {
                            console.error('Error al guardar producto:', error);
                            alert('No se pudo guardar el producto.');
                        });
                }
            },


            editarProducto(producto) {
                this.mostrarFormulario = true;
                this.producto = { ...producto };
                this.productoEditandoId = producto.id;  // Establecer ID del producto a editar
            },

            eliminarProducto(productoId) {
                console.log("Eliminando producto con ID:", productoId)
                fetch(`/api/productos/${productoId}/`, {
                    method: 'DELETE',
                    headers: this.getAuthHeaders()
                })
                    .then(res => {
                        if (!res.ok) {
                            console.error('Error al eliminar producto');
                            alert('No se pudo eliminar el producto.');
                            return;
                        }
                        this.fetchProductos();  // Recargar productos después de eliminar
                    })
                    .catch(error => console.error('Error al eliminar producto:', error));
            },


            activarFormularioNegocio() {
                this.mostrarFormularioNegocio = true;
            }
        },
        computed: {
            negocioSeleccionado() {
                return this.negocios.find(n => n.id === this.negocioSeleccionadoId) || {};
            }
        }
    });


</script>
{% endblock %}